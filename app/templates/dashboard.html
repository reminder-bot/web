<!DOCTYPE html>
<html>
    <head>

        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
        <link rel="manifest" href="/{{ url_for('static', filename='favicon/site.webmanifest') }}">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Reminder Bot - Dashboard</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
        <!-- Theme style -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/AdminLTE.min.css') }}">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
            folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/_all-skins.min.css') }}">
        <!-- Date Picker -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-datepicker.min.css') }}">
        <!-- Bootstrap time Picker -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-timepicker.min.css') }}">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-colorpicker.min.css') }}">

        <script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
        <script src="{{ url_for('static', filename='js/bootstrap.js') }}"></script>

        <script src="{{ url_for('static', filename='js/adminlte.min.js') }}"></script>

        <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
        <!-- datepicker -->
        <script src="{{ url_for('static', filename='js/bootstrap-datepicker.min.js') }}"></script>
        <!-- bootstrap time picker -->
        <script src="{{ url_for('static', filename='js/bootstrap-timepicker.min.js') }}"></script>

        <script src="{{ url_for('static', filename='js/bootstrap-colorpicker.min.js') }}"></script>

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    </head>

    <body class="hold-transition skin-green sidebar-mini">
        <div class="wrapper">
            <header class="main-header">
                <!-- Logo -->
                <a href="{{ url_for('help') }}" class="logo">
                    <!-- logo for regular state and mobile devices -->
                    <span class="logo-lg"><strong>Reminder</strong> Bot</span>
                </a>
                <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                    <i class="fas fa-bars"></i>
                    <span class="sr-only">Toggle navigation.</span>
                </a>
                <!-- Header Navbar: style can be found in header.less -->
                <nav class="navbar navbar-top hidden-xs">
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">

                        </ul>
                    </div>
                </nav>
            </header>

            <aside class="main-sidebar">
                <section class="sidebar">
                    <ul class="sidebar-menu" data-widget="tree">
                        <li class="header">GUILDS</li>
                        <li style="margin-left: 2rem; margin-bottom: 1rem;"><a href="{{ url_for('dashboard', id=0) }}">@{{ user['username'] }}</a></li>
                        {% for guild in guilds %}
                            <li style="margin-left: 2rem;"><a href="{{ url_for('dashboard', id=guild['id']) }}">{{ guild['name'] }}</a></li>
                        {% endfor %}
                    </ul>
                </section>
            </aside>

            <div class="content-wrapper">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-danger alert-dismissable">
                                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% if not out %}
                <section class="content-header">
                    <h1>
                        Dashboard
                        <small>Reminders</small>
                    </h1>
                </section>

                <section class="content">

                    <div class="container" style="width: 100%">
                        <div class="row" style="width: 100%">
                            {% for reminder in reminders %}

                                {% include "card.html" %}

                            {% endfor %}

                            {% set reminder = False %}

                            {% include "card.html" %}
                        </div>
                    </div>

                </section>

                {% else %}
                    <section class="content-header">
                        <h1>
                            Please select a guild.
                        </h1>
                        <p class="text-muted">This website is tested on Chrome and Firefox. Please report any issues in my Discord guild.</p>
                    </section>
                {% endif %}
            </div>
        </div>

        <script>

{% if server != None %}
var channels = {
    {% for channel in channels %}
    "{{ channel['name'].replace('\\', '')[:16] }}": "{{ channel['id'] }}",
    {% endfor %}
};

var members = {
    {% for member in members %}
    "{{ member['user']['username'].replace('\\', '').lower()[:16] }}": "{{ member['user']['id'] }}",
    {% endfor %}
};

var roles = {
    {% for role in roles %}
    "@{{ role['name'].replace('\\', '').lower()[:16] }}": "&{{ role['id'] }}",
    {% endfor %}
};

function mention(id, i)
{
    var value = document.getElementById("input-message" + i).value;
    value = value.split(" ").slice(0, -1).join(" ") + " " + id;
    document.getElementById("input-message" + i).value = value;
}

function manage_characters(e, i)
{
    var text = e.target.value;
    var parts = text.split(" ");
    var last = parts[parts.length-1].toLowerCase();
    var name = last.slice(1);

    var type = last[0];

    var out = [];

    if ( type === "@" )
    {
        var roles_also = last[1] == "@";

        if ( roles_also ) 
        {
            var set = roles;
        }
        else 
        {
            var set = members
        }

        document.getElementById("mention-input" + i).style.visibility = "visible";

        for ( key in set )
        {
            if ( key.includes(name) )
            {
                out.push("@" + key);
            }
        }
    }
    else if ( type === "#" )
    {
        document.getElementById("mention-input" + i).style.visibility = "visible";

        for (key in channels)
        {
            if ( key.includes(name) )
            {
                out.push("#" + key);
            }
        }
    }
    else
    {
        document.getElementById("mention-input" + i).style.visibility = "hidden";
    }

    document.getElementById("dropdown-mention" + i).innerHTML = "";

    out.sort();

    for (el in out)
    {
        var name_n = out[el];
        if ( type === "@" )
        {
            if ( last[1] === "@" ) 
            {
                var id = roles[name_n.slice(1)];
            }
            else
            {
                var id = members[name_n.slice(1)];
            }
            document.getElementById("dropdown-mention" + i).innerHTML += `<li><a onclick="javascript:mention('<@${id}>', ${i})">${name_n}</a></li>`;
        }
        else
        {
            var id = channels[name_n.slice(1)];
            document.getElementById("dropdown-mention" + i).innerHTML += `<li><a onclick="javascript:mention('<#${id}>', ${i})">${name_n}</a></li>`;
        }
    }
}

{% for reminder in reminders %}
    
    function m{{ reminder.index }}(e) {
        manage_characters(e, {{ reminder.index }});
    }

    document.getElementById("input-message{{ reminder.index }}").addEventListener("input", m{{ reminder.index }});

{% endfor %}
{% endif %}

$(function() {
    $('#cp2').colorpicker({"format": "hex"});
});


update_time();

function send_delete(index)
{
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            location.reload(true);
        }
    };
    xhttp.open("GET", "{{ url_for('delete') }}" + "?index=" + index, true);
    xhttp.send();
}

        </script>
    </body>
</html>
