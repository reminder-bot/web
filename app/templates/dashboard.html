<!DOCTYPE html>
<html>
    <head>

        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
        <link rel="manifest" href="/{{ url_for('static', filename='favicon/site.webmanifest') }}">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Reminder Bot - Dashboard</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome.min.css') }}">
        <!-- Theme style -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/AdminLTE.min.css') }}">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
            folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/_all-skins.min.css') }}">
        <!-- Date Picker -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-datepicker.min.css') }}">
        <!-- Bootstrap time Picker -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-timepicker.min.css') }}">

        <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-colorpicker.min.css') }}">

        <script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
        <script src="{{ url_for('static', filename='js/bootstrap.js') }}"></script>

        <script src="{{ url_for('static', filename='js/adminlte.min.js') }}"></script>

        <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
        <!-- datepicker -->
        <script src="{{ url_for('static', filename='js/bootstrap-datepicker.min.js') }}"></script>
        <!-- bootstrap time picker -->
        <script src="{{ url_for('static', filename='js/bootstrap-timepicker.min.js') }}"></script>

        <script src="{{ url_for('static', filename='js/bootstrap-colorpicker.min.js') }}"></script>

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    </head>

    <body class="hold-transition skin-green sidebar-mini">
        <div class="wrapper">
            <header class="main-header">
                <!-- Logo -->
                <a href="{{ url_for('help') }}" class="logo">
                    <!-- logo for regular state and mobile devices -->
                    <span class="logo-lg"><b>Reminder</b>BOT</span>
                </a>
                <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                    <i class="fas fa-bars"></i>
                    <span class="sr-only">Toggle navigation.</span>
                </a>
                <!-- Header Navbar: style can be found in header.less -->
                <nav class="navbar navbar-top hidden-xs">
                    <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">

                        </ul>
                    </div>
                </nav>
            </header>

            <aside class="main-sidebar">
                <section class="sidebar">
                    <ul class="sidebar-menu" data-widget="tree">
                        <li class="header">GUILDS</li>
                        <li style="margin-left: 2rem; margin-bottom: 1rem;"><a href="{{ url_for('dashboard', id=0) }}">@{{ user['username'] }}</a></li>
                        {% for guild in guilds %}
                            <li style="margin-left: 2rem;"><a href="{{ url_for('dashboard', id=guild['id']) }}">{{ guild['name'] }}</a></li>
                        {% endfor %}
                    </ul>
                </section>
            </aside>

            <div class="content-wrapper">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-danger alert-dismissable">
                                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% if not out %}
                <section class="content-header">
                    <h1>
                        Dashboard
                        <small>Reminders</small>
                    </h1>
                </section>

                <section class="content">
                    <div class="box">
                        <div class="box-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 50%; overflow: hidden;">Message</th>
                                        <th style="width: 10%;">Time</th>
                                        {% if server != None %}
                                        <th style="width: 15%;">Channel</th>
                                        {% endif %}
                                        <th style="width: 10%;">Interval</th>
                                        <th style="width: 15%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reminder in reminders %}

                                    <form action="{{ url_for('change_reminder', index=reminder['index'], redirect=server.id) }}" method="POST">

                                        <tr>
                                            <td>
                                                <textarea name="message_new" style="width: 100%">{{ reminder['message'] }}</textarea>
                                            </td>

                                            <td id="time_val_{{ reminder['index'] }}"><a data-toggle="tooltip" title="tooltip text">{{ reminder['time'] }}</a></td>
                                            <input name="time_new" value="{{ reminder['time'] }}" hidden></input>

                                            <script>

var t2 = {{ reminder['time'] }};
var l = moment.unix(t2).calendar();
var t = moment.unix(t2).format("dddd, MMM Do YYYY, HH:mm");
document.getElementById('time_val_' + {{ reminder['index'] }}).innerHTML = `<a data-toggle="tooltip" title="${t}">${l}</a>`;

                                            </script>

                                            {% if server != None %}
                                            <td>#{{ reminder['channel']['name'] }}</td>
                                            <input name="channel_new" value="{{ reminder['channel']['id'] }}" hidden></input>
                                            {% endif %}

                                            <td>{{ reminder['interval'] }}{% if reminder['interval'] != None %}s{% endif %}</td>

                                            <td>
                                                <button onclick="send_delete('{{ reminder['index'] }}')" class="guildbtn btn btn-danger btn-fill"><i class="fa fa-times"></i></button>
                                                <button type="submit" class="guildbtn btn btn-info btn-fill"><i class="fas fa-save"></i></button>
                                            </td>
                                        </tr>
                                    </form>

                                    {% endfor %}

                                </tbody>
                            </table>
                            <div class="text-center">
                                <hr>
                                <button data-toggle="modal" data-target="#addModal" class="guildbtn btn btn-success btn-fill">Add Reminder</button>
                                {% if server != None %}
                                    <button data-toggle="modal" data-target="#addModal2" class="guildbtn btn btn-primary btn-fill">Edit Server Settings</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="modal fade col-md-12" id="addModal" data-backdrop="false">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                {% include "modal.html" %}
                            </div>
                        </div>
                    </div>
                    <!-- BLOCK CONTENT -->
                    <div class="modal fade col-md-12" id="addModal2" data-backdrop="false">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="post">
                                    <input name="update-server" hidden></input>

                                    <div class="modal-header">
                                        <h4>Edit Server Settings</h4>
                                    </div>
                                    <div class="modal-body">
                                        <!-- MESSAGE -->
                                        <div class="form-group">
                                            <label>Prefix:</label>
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fa fa-exclamation-circle"></i>
                                                </div>
                                                <input type="text" name="prefix" class="form-control pull-right" value="{{ server.prefix }}" maxlength="5">
                                            </div>
                                            <!-- /.input group -->
                                        </div>
                                        <!-- CHANNEL -->
                                        <div class="form-group">
                                            <label>Timezone:</label>
                                            <div class="input-group">
                                                <div class="input-group-addon">
                                                    <i class="fas fa-clock"></i>
                                                </div>
                                                <input type="text" name="timezone" id="timezone" hidden>
                                                <div class="dropdown">
                                                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdown-timezone" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                                        {{ server.timezone }}
                                                        <span class="caret"></span>
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="max-height: 40vh; overflow-y: scroll;">
                                                        {% for tz in timezones %}
                                                            <li><a onclick="javascript:change_tz('{{ tz[1] }}')">{{ tz[1] }} (GMT {{ tz[0] }})</a></li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                            <!-- /.input group -->
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-success">Submit</button>
                                            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                {% else %}
                <section class="content-header">
                    <h1>
                        Please select a guild.
                    </h1>
                    <p class="text-muted">This website is tested on Chrome and Firefox. Please report any issues in my Discord guild.</p>
                </section>
                {% endif %}
            </div>
        </div>

        <script>


var channels = {
    {% for channel in channels %}
    "{{ channel['name'].replace('\\', '')[:16] }}": "{{ channel['id'] }}",
    {% endfor %}
};

var members = {
    {% for member in members %}
    "{{ member['user']['username'].replace('\\', '').lower()[:16] }}": "{{ member['user']['id'] }}",
    {% endfor %}
};

var roles = {
    {% for role in roles %}
    "@{{ role['name'].replace('\\', '').lower()[:16] }}": "&{{ role['id'] }}",
    {% endfor %}
};


$(function() {
    $('#cp2').colorpicker({"format": "hex"});
});

//Date picker
$('#datepicker').datepicker({
    format: 'yyyy/mm/dd',
    autoclose: true
})

$('#datepicker').datepicker('update', new Date());
//Timepicker
$('.timepicker').timepicker({
    minuteStep: 1,
    showInputs: false,
    showSeconds: true,
})

$("#datepicker").change(update_time);
$("#timepicker").change(update_time);


function update_time()
{
    t_time = document.getElementById("timepicker");
    d_time = document.getElementById("datepicker");

    m = moment(d_time.value + ' ' + t_time.value, 'YYYY/MM/DD HH:mm:ss A')

    document.getElementById("time_new").value = m.unix();
}

update_time();

function change_channel(id, name, index)
{

    if (index === undefined)
    {
        document.getElementById('input-channel').value = id;
        document.getElementById('dropdown-channel').innerHTML = name + "<span class=\"caret\"></span>";
    }
    else
    {
        document.getElementById('input-channel-' + index).value = id;
        document.getElementById('dropdown-channel-' + index).innerHTML = name + "<span class=\"caret\"></span>";
    }
}

function change_tz(timezone)
{
    document.getElementById('timezone').value = timezone;
    document.getElementById('dropdown-timezone').innerHTML = timezone + "<span class=\"caret\"></span>"
}

function send_delete(index)
{
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            location.reload(true);
        }
    };
    xhttp.open("GET", "{{ url_for('delete') }}" + "?index=" + index, true);
    xhttp.send();
}

function validate_input()
{
    message = document.getElementById('input-message');
    channel = document.getElementById('input-channel');

    modal = document.getElementById('modal');

    modal.innerHTML = '';

    failed = false;

    if (message.value == '')
    {
        a = document.createElement('div');
        a.className = 'alert alert-danger';
        a.innerHTML = 'Please add a message';
        modal.appendChild(a);

        failed = true;
    }
    if (channel.value == '')
    {
        a = document.createElement('div');
        a.className = 'alert alert-danger';
        a.innerHTML = 'Please add a channel';
        modal.appendChild(a);

        failed = true;
    }

    return !failed;
}

function mention(id)
{
    var value = document.getElementById("input-message").value;
    value = value.split(" ").slice(0, -1).join(" ") + " " + id;
    document.getElementById("input-message").value = value;
}

function manage_characters(e)
{
    var text = e.target.value;
    var parts = text.split(" ");
    var last = parts[parts.length-1].toLowerCase();
    var name = last.slice(1);

    var type = last[0];

    var out = [];

    if ( type === "@" )
    {
        var roles_also = last[1] == "@";

        if ( roles_also ) 
        {
            var set = roles;
        }
        else 
        {
            var set = members
        }

        document.getElementById("mention-input").style.visibility = "visible";

        for ( key in set )
        {
            if ( key.includes(name) )
            {
                out.push("@" + key);
            }
        }
    }
    else if ( type === "#" )
    {
        document.getElementById("mention-input").style.visibility = "visible";

        for (key in channels)
        {
            if ( key.includes(name) )
            {
                out.push("#" + key);
            }
        }
    }
    else
    {
        document.getElementById("mention-input").style.visibility = "hidden";
    }

    document.getElementById("dropdown-mention").innerHTML = "";

    out.sort();

    for (el in out)
    {
        var name_n = out[el];
        if ( type === "@" )
        {
            if ( last[1] === "@" ) 
            {
                var id = roles[name_n.slice(1)];
            }
            else
            {
                var id = members[name_n.slice(1)];
            }
            document.getElementById("dropdown-mention").innerHTML += `<li><a onclick="javascript:mention('<@${id}>')">${name_n}</a></li>`;
        }
        else
        {
            var id = channels[name_n.slice(1)];
            document.getElementById("dropdown-mention").innerHTML += `<li><a onclick="javascript:mention('<#${id}>')">${name_n}</a></li>`;
        }
    }
}

{% if server != None %}
function toggle_colorpicker()
{
    check = document.getElementById("checkb");
    if (check.checked)
    {
        document.getElementById("colorpicker").style.opacity = 1;
    }
    else
    {
        document.getElementById("colorpicker").style.opacity = 0;
    }
}
toggle_colorpicker();
{% endif %}

document.getElementById("input-message").addEventListener("input", manage_characters);

$(document).ready(function(){
    // Initialize
    $('[data-toggle="tooltip"]').tooltip();
});

        </script>
    </body>
</html>
